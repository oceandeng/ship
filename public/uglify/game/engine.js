"use strict";var sW=document.documentElement.clientWidth,sH=document.documentElement.clientHeight,Game=new function(){this.initialize=function(a,b,c){return sW=document.documentElement.clientWidth,sH=document.documentElement.clientHeight,this.canvas=document.getElementById(a),this.canvas.width=sW,this.canvas.height=sH,this.width=sW,this.height=sH,this.ctx=this.canvas.getContext&&this.canvas.getContext("2d"),this.ctx?(this.playerOffset=10,this.canvasMultiplier=1,this.setupMobile(),this.setupInput(),this.mobile&&this.setBoard(4,new TouchControls),this.loop(),void SpriteSheet.load(b,c)):alert("Please upgrade your brower to play")},this.resize=function(a,b){sW=document.documentElement.clientWidth,sH=document.documentElement.clientHeight,this.canvas.width=sW,this.canvas.height=sH,this.width=sW,this.height=sH,b&&SpriteSheet.load(a,b)};var a={37:"left",39:"right",32:"fire"};this.keys={},this.setupInput=function(){window.addEventListener("keydown",function(b){a[event.keyCode]&&(Game.keys[a[event.keyCode]]=!0,b.preventDefault())},!1),window.addEventListener("keyup",function(b){a[event.keyCode]&&(Game.keys[a[event.keyCode]]=!1,b.preventDefault())},!1)};var b=[];this.loop=function(){for(var a=.03,c=0,d=b.length;d>c;c++)b[c]&&(b[c].step(a),b[c]&&b[c].draw(Game.ctx));setTimeout(Game.loop,30)},this.setBoard=function(a,c){b[a]=c},this.setupMobile=function(){var a=document.querySelector("#container"),b=!!("ontouchstart"in window),c=window.innerWidth,d=window.innerHeight;return b&&(this.mobile=!0),screen.width>=1280||!b?!1:(c>d&&(alert("Please rotate the device and then click OK"),c=window.innerWidth,d=window.innerHeight),a.style.height=2*d+"px",window.scrollTo(0,1),d=window.innerHeight+2,a.style.height=d+"px",a.style.width=c+"px",a.style.padding=0,d>=1.75*this.canvas.height||c>=1.75*this.canvas.height?(this.canvasMultiplier=2,this.canvas.width=c/2,this.canvas.height=d/2,this.canvas.style.width=c+"px",this.canvas.style.height=d+"px"):(this.canvas.width=c,this.canvas.height=d),this.canvas.style.popsition="absolute",this.canvas.style.left="0px",void(this.canvas.style.top="0px"))}},SpriteSheet=new function(){this.map={},this.load=function(a,b){this.map=a,this.image=new Image,this.image.onload=b,this.image.src="images/sprites.png"},this.draw=function(a,b,c,d,e){var f=this.map[b];e||(e=0),a.drawImage(this.image,f.sx+e*f.w,f.sy,f.w,f.h,Math.floor(c),Math.floor(d),f.w,f.h)}},TitleScreen=function(a,b,c){var d=!1;this.step=function(a){Game.keys.fire||(d=!0),d&&Game.keys.fire&&c&&c()},this.draw=function(c){c.fillStyle="#008daf",c.textAlign="center",c.font="30px Microsoft Yahei",c.fillText(a,Game.width/2,Game.height/2),c.font="20px Microsoft Yahei",c.fillText(b,Game.width/2,Game.height/2+40)}},GameBoard=function(){var a=this;this.objects=[],this.cnt={},this.add=function(a){return a.board=this,this.objects.push(a),this.cnt[a.type]=(this.cnt[a.type]||0)+1,a},this.remove=function(a){var b=this.removed.indexOf(a);return-1==b?(this.removed.push(a),!0):!1},this.resetRemoved=function(){this.removed=[]},this.finalizeRemoved=function(){for(var a=0,b=this.removed.length;b>a;a++){var c=this.objects.indexOf(this.removed[a]);-1!=c&&(this.cnt[this.removed[a].type]--,this.objects.splice(c,1))}},this.iterate=function(a){for(var b=Array.prototype.slice.call(arguments,1),c=0,d=this.objects.length;d>c;c++){var e=this.objects[c];e[a].apply(e,b)}},this.detect=function(a){for(var b=0,c=this.objects.length;c>b;b++)if(a.call(this.objects[b]))return this.objects[b];return!1},this.step=function(a){this.resetRemoved(),this.iterate("step",a),this.finalizeRemoved()},this.draw=function(a){this.iterate("draw",a)},this.overlap=function(a,b){return!(a.y+a.h-1<b.y||a.y>b.y+b.h-1||a.x+a.w-1<b.x||a.x>b.x+b.w-1)},this.collide=function(b,c){return this.detect(function(){if(b!=this){var d=(!c||this.type&c)&&a.overlap(b,this);return d?this:!1}})}},Sprite=function(){};Sprite.prototype.setup=function(a,b){this.sprite=a,this.merge(b),this.frame=this.frame||0,this.w=SpriteSheet.map[a].w,this.h=SpriteSheet.map[a].h},Sprite.prototype.merge=function(a){if(a)for(var b in a)this[b]=a[b]},Sprite.prototype.draw=function(a){SpriteSheet.draw(a,this.sprite,this.x,this.y,this.frame)},Sprite.prototype.hit=function(a){this.board.remove(this)};var Level=function(a,b){this.levelData=[];for(var c=0;c<a.length;c++)this.levelData.push(Object.create(a[c]));this.t=0,this.callback=b};Level.prototype.step=function(a){var b=0,c=[],d=null;for(this.t+=1e3*a;(d=this.levelData[b])&&d[0]<this.t+2e3;){if(this.t>d[1])c.push(d);else if(d[0]<this.t){var e=enemies[d[3]],f=d[4];this.board.add(new Enemy(e,f)),d[0]+=d[2]}b++}for(var g=0,h=c.length;h>g;g++){var i=this.levelData.indexOf(c[g]);-1!=i&&this.levelData.splice(i,1)}0==this.levelData.length&&0==this.board.cnt[OBJECT_ENEMY]&&this.callback&&this.callback()},Level.prototype.draw=function(a){};var TouchControls=function(){var a=10,b=Game.width/5,c=b-a;this.drawSquare=function(a,b,d,e,f){a.globalAlpha=f?.9:.6,a.fillStyle="#ccc",a.fillRect(b,d,c,c/3),a.fillStyle="#fff",a.textAlign="center",a.globalAlpha=1,a.font="12px arial",a.fillText(e,b+c/2,d+3*c/8-10)},this.draw=function(c){c.save();var d=Game.height-b/2;this.drawSquare(c,a,d,"<",Game.keys.left),this.drawSquare(c,4*b,d,">",Game.keys.right),c.restore()},this.step=function(){},this.trackTouch=function(a){var c,d;a.preventDefault(),Game.keys.left=!1,Game.keys.right=!1;for(var e=0;e<a.targetTouches.length;e++)c=a.targetTouches[e],d=c.pageX/Game.canvasMultiplier-Game.canvas.offsetLeft,b>d&&(Game.keys.left=!0),d>4*b&&(Game.keys.right=!0);Game.keys.fire="touchstart"==a.type},Game.canvas.addEventListener("touchstart",this.trackTouch,!0),Game.canvas.addEventListener("touchmove",this.trackTouch,!0),Game.canvas.addEventListener("touchend",this.trackTouch,!0),Game.playerOffset=b-40},GamePoints=function(){Game.points=0;var a=8;this.draw=function(b){b.save(),b.font="bold 18px arial",b.textAlign="left",b.fillStyle="#fff";for(var c=""+Game.points,d=a-c.length,e="";d-- >0;)e+="0";b.fillText(e+c,10,20),b.restore()},this.step=function(a){}};